<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Post - Robert Tolan</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/dreampulse/computer-modern-web-font/master/fonts.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: "Computer Modern Sans", -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        body.light-mode {
            background: #f8f9fa;
            color: #333;
        }
        
        .editor-container {
            max-width: 100%;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            margin-bottom: 30px;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        body.light-mode .header {
            border-bottom: 1px solid #ddd;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }
        
        body.light-mode .header h1 {
            color: #333;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .theme-toggle, .preview-toggle {
            background: #444;
            border: 1px solid #555;
            color: #ccc;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .theme-toggle:hover, .preview-toggle:hover {
            background: #555;
            color: #fff;
        }
        
        body.light-mode .theme-toggle,
        body.light-mode .preview-toggle {
            background: #e9ecef;
            border: 1px solid #ddd;
            color: #666;
        }
        
        body.light-mode .theme-toggle:hover,
        body.light-mode .preview-toggle:hover {
            background: #dee2e6;
            color: #333;
        }
        
        .preview-toggle.active {
            background: #0066cc;
            color: #fff;
            border-color: #0077ee;
        }
        
        body.light-mode .preview-toggle.active {
            background: #0066cc;
            color: #fff;
        }
        
        .save-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .save-status.idle {
            color: #888;
            background: #333;
            border: 1px solid #444;
        }
        
        body.light-mode .save-status.idle {
            color: #666;
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
        
        .save-status.saving {
            color: #ffd700;
            background: #2a2a2a;
            border: 1px solid #555;
        }
        
        body.light-mode .save-status.saving {
            color: #b8860b;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        
        .save-status.saved {
            color: #4caf50;
            background: #2a2a2a;
            border: 1px solid #4caf50;
        }
        
        body.light-mode .save-status.saved {
            color: #2e7d32;
            background: #e8f5e8;
            border: 1px solid #4caf50;
        }
        
        .save-status.error {
            color: #f44336;
            background: #2a2a2a;
            border: 1px solid #f44336;
        }
        
        body.light-mode .save-status.error {
            color: #c62828;
            background: #ffebee;
            border: 1px solid #f44336;
        }
        

        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ccc;
            font-size: 14px;
        }
        
        body.light-mode label {
            color: #666;
        }
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 6px;
            font-family: inherit;
            font-size: 16px;
            background: #2a2a2a;
            color: #e0e0e0;
            transition: border-color 0.2s ease, background-color 0.3s ease, color 0.3s ease;
        }
        
        body.light-mode input[type="text"], 
        body.light-mode textarea, 
        body.light-mode select {
            border: 1px solid #ddd;
            background: #fff;
            color: #333;
        }
        
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #666;
            background: #333;
        }
        
        body.light-mode input[type="text"]:focus, 
        body.light-mode textarea:focus, 
        body.light-mode select:focus {
            border-color: #0066cc;
            background: #fff;
        }
        
        textarea {
            min-height: 400px;
            resize: vertical;
            line-height: 1.6;
        }
        
        .content-editor {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .editor-panel, .preview-panel {
            flex: 1;
            min-height: 500px;
        }
        
        .preview-panel {
            display: none;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 20px;
            overflow-y: auto;
            max-height: 600px;
        }
        
        body.light-mode .preview-panel {
            background: #fff;
            border: 1px solid #ddd;
        }
        
        .preview-panel.active {
            display: block;
        }
        
        .preview-content {
            line-height: 1.7;
            color: #e0e0e0;
        }
        
        body.light-mode .preview-content {
            color: #333;
        }
        
        .preview-content h1, .preview-content h2, .preview-content h3,
        .preview-content h4, .preview-content h5, .preview-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #fff;
        }
        
        body.light-mode .preview-content h1, 
        body.light-mode .preview-content h2, 
        body.light-mode .preview-content h3,
        body.light-mode .preview-content h4, 
        body.light-mode .preview-content h5, 
        body.light-mode .preview-content h6 {
            color: #333;
        }
        
        .preview-content h1 { font-size: 2em; }
        .preview-content h2 { font-size: 1.5em; }
        .preview-content h3 { font-size: 1.25em; }
        
        .preview-content p {
            margin-bottom: 1em;
        }
        
        .preview-content blockquote {
            border-left: 4px solid #666;
            padding-left: 1em;
            margin: 1em 0;
            font-style: italic;
            color: #ccc;
        }
        
        body.light-mode .preview-content blockquote {
            border-left-color: #ddd;
            color: #666;
        }
        
        .preview-content code {
            background: #444;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        body.light-mode .preview-content code {
            background: #f1f3f4;
        }
        
        .preview-content pre {
            background: #333;
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1em 0;
        }
        
        body.light-mode .preview-content pre {
            background: #f8f9fa;
        }
        
        .preview-content pre code {
            background: none;
            padding: 0;
        }
        
        .preview-content a {
            color: #0066cc;
            text-decoration: none;
        }
        
        .preview-content a:hover {
            text-decoration: underline;
        }
        
        .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 1em 0;
        }
        
        .preview-content ul, .preview-content ol {
            margin: 1em 0;
            padding-left: 2em;
        }
        
        .preview-content li {
            margin-bottom: 0.5em;
        }
        
        .toolbar {
            display: flex;
            gap: 4px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            padding: 12px;
            background: #2a2a2a;
            border-radius: 6px;
            border: 1px solid #444;
            align-items: center;
        }
        
        body.light-mode .toolbar {
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
        
        .toolbar-group {
            display: flex;
            gap: 2px;
        }
        
        .toolbar-separator {
            width: 1px;
            height: 24px;
            background: #555;
            margin: 0 8px;
        }
        
        body.light-mode .toolbar-separator {
            background: #ddd;
        }
        
        .toolbar-btn {
            background: #333;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #ccc;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
        }
        
        .toolbar-btn:hover {
            background: #444;
            color: #fff;
            border-color: #666;
            transform: translateY(-1px);
        }
        
        .toolbar-btn:active {
            transform: translateY(0);
        }
        
        .toolbar-btn i {
            font-size: 14px;
        }
        
        .toolbar-btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 4px;
        }
        
        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 40px;
            padding: 8px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
        }
        
        body.light-mode .tags-input {
            background: #fff;
            border: 1px solid #ddd;
        }
        
        .tag {
            background: #444;
            color: #e0e0e0;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        body.light-mode .tag {
            background: #e9ecef;
            color: #495057;
        }
        
        .tag .remove-tag {
            cursor: pointer;
            color: #999;
            font-size: 10px;
        }
        
        .tag .remove-tag:hover {
            color: #ff6b6b;
        }
        
        .tag-input {
            border: none;
            background: transparent;
            color: #e0e0e0;
            font-size: 12px;
            outline: none;
            min-width: 60px;
            flex: 1;
        }
        
        body.light-mode .tag-input {
            color: #333;
        }
        
        .tag-input::placeholder {
            color: #666;
        }
        
        body.light-mode .tag-input::placeholder {
            color: #999;
        }
        
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .image-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            border: 1px solid #444;
        }
        
        .image-modal-content h3,
        .link-modal-content h3 {
            margin: 0 0 20px 0;
            color: #fff;
            font-size: 18px;
        }
        
        .image-upload-area {
            border: 2px dashed #555;
            border-radius: 6px;
            padding: 30px;
            text-align: center;
            background: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            color: #ccc;
        }
        
        .image-upload-area:hover {
            background: #444;
            border-color: #666;
        }
        
        .image-upload-area.dragover {
            background: #555;
            color: #fff;
            border-color: #777;
        }
        
        .image-preview {
            margin-top: 15px;
            text-align: center;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
        }
        
        /* Link Modal Styles */
        .link-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .link-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            border: 1px solid #444;
        }
        
        .link-preview {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid #555;
        }
        
        body.light-mode .link-preview {
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        /* Find & Replace Modal Styles */
        .find-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .find-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            border: 1px solid #444;
        }
        
        .find-results {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid #555;
        }
        
        body.light-mode .find-results {
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
        
        /* Word Count & Reading Time Styles */
        .content-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            font-size: 14px;
        }
        
        body.light-mode .content-stats {
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ccc;
        }
        
        body.light-mode .stat-item {
            color: #666;
        }
        
        .stat-item i {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .stat-value {
            font-weight: 600;
            color: #fff;
        }
        
        body.light-mode .stat-value {
            color: #333;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .reading-time {
            color: #4caf50;
        }
        
        body.light-mode .reading-time {
            color: #2e7d32;
        }
        
        .word-count {
            color: #2196f3;
        }
        
        body.light-mode .word-count {
            color: #1976d2;
        }
        
        .char-count {
            color: #ff9800;
        }
        
        body.light-mode .char-count {
            color: #f57c00;
        }
        
        /* SEO Section Styles */
        .seo-section {
            margin-top: 30px;
            padding: 20px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
        }
        
        body.light-mode .seo-section {
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
        
        .seo-section h3 {
            margin: 0 0 20px 0;
            color: #fff;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        body.light-mode .seo-section h3 {
            color: #333;
        }
        
        .seo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .seo-item {
            display: flex;
            flex-direction: column;
        }
        
        .seo-item label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #ccc;
            font-size: 14px;
        }
        
        body.light-mode .seo-item label {
            color: #666;
        }
        
        .seo-item textarea,
        .seo-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            background: #333;
            color: #e0e0e0;
            resize: vertical;
        }
        
        body.light-mode .seo-item textarea,
        body.light-mode .seo-item input {
            border: 1px solid #ddd;
            background: #fff;
            color: #333;
        }
        
        .seo-counter {
            margin-top: 5px;
            font-size: 12px;
            color: #888;
            text-align: right;
        }
        
        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .keyword-tag {
            background: #444;
            color: #e0e0e0;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        body.light-mode .keyword-tag {
            background: #e9ecef;
            color: #495057;
        }
        
        .keyword-tag .remove-keyword {
            cursor: pointer;
            color: #999;
            font-size: 10px;
        }
        
        .keyword-tag .remove-keyword:hover {
            color: #ff6b6b;
        }
        
        .url-preview {
            margin-top: 8px;
            padding: 8px;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #ccc;
        }
        
        body.light-mode .url-preview {
            background: #f8f9fa;
            border: 1px solid #ddd;
            color: #666;
        }
        
        .url-prefix {
            color: #888;
        }
        
        .seo-analysis {
            border-top: 1px solid #444;
            padding-top: 20px;
        }
        
        body.light-mode .seo-analysis {
            border-top: 1px solid #ddd;
        }
        
        .seo-analysis h4 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        body.light-mode .seo-analysis h4 {
            color: #333;
        }
        
        .seo-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .seo-metric {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #333;
            border: 1px solid #555;
            border-radius: 6px;
        }
        
        body.light-mode .seo-metric {
            background: #fff;
            border: 1px solid #ddd;
        }
        
        .metric-icon {
            font-size: 18px;
        }
        
        .metric-icon .fa-check-circle {
            color: #4caf50;
        }
        
        .metric-icon .fa-exclamation-triangle {
            color: #ff9800;
        }
        
        .metric-icon .fa-times-circle {
            color: #f44336;
        }
        
        .metric-content {
            flex: 1;
        }
        
        .metric-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 2px;
        }
        
        .metric-value {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }
        
        body.light-mode .metric-value {
            color: #333;
        }
        
        .seo-suggestions {
            background: #333;
            border: 1px solid #555;
            border-radius: 6px;
            padding: 15px;
        }
        
        body.light-mode .seo-suggestions {
            background: #fff;
            border: 1px solid #ddd;
        }
        
        .seo-suggestions h5 {
            margin: 0 0 10px 0;
            color: #fff;
            font-size: 14px;
        }
        
        body.light-mode .seo-suggestions h5 {
            color: #333;
        }
        
        .seo-suggestions ul {
            margin: 0;
            padding-left: 20px;
            color: #ccc;
            font-size: 13px;
        }
        
        body.light-mode .seo-suggestions ul {
            color: #666;
        }
        
        .seo-suggestions li {
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .seo-grid {
                grid-template-columns: 1fr;
            }
            
            .seo-metrics {
                grid-template-columns: 1fr;
            }
        }
        
        .button {
            background: #444;
            color: #e0e0e0;
            padding: 12px 24px;
            border: 1px solid #555;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .button:hover {
            background: #555;
            color: #fff;
        }
        
        .button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        .button.primary {
            background: #0066cc;
            color: #fff;
            border-color: #0077ee;
        }
        
        .button.primary:hover {
            background: #0077ee;
        }
        
        .success-message {
            background: #2d5a2d;
            color: #b8e6b8;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            text-align: center;
            display: none;
            border: 1px solid #3a6a3a;
        }
        
        .error-message {
            background: #5a2d2d;
            color: #e6b8b8;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            text-align: center;
            display: none;
            border: 1px solid #6a3a3a;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .publish-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }
        
        body.light-mode .publish-section {
            border-top: 1px solid #ddd;
        }
        
        .publish-options {
            margin-bottom: 20px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: #ccc;
        }
        
        body.light-mode .checkbox-label {
            color: #666;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid #555;
            border-radius: 3px;
            display: inline-block;
            position: relative;
            background: #333;
        }
        
        body.light-mode .checkmark {
            border-color: #ddd;
            background: #fff;
        }
        
        .checkbox-label input[type="checkbox"]:checked + .checkmark:after {
            content: 'âœ“';
            position: absolute;
            top: -2px;
            left: 2px;
            color: #fff;
            font-size: 12px;
        }
        
        body.light-mode .checkbox-label input[type="checkbox"]:checked + .checkmark:after {
            color: #333;
        }
        
        /* PDF Upload Styles */
        .pdf-upload-section {
            margin-top: 10px;
        }
        
        .pdf-folder-controls {
            margin-bottom: 15px;
            padding: 15px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
        }
        
        body.light-mode .pdf-folder-controls {
            background: #f8f9fa;
            border-color: #ddd;
        }
        
        .pdf-folder-controls label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ccc;
        }
        
        body.light-mode .pdf-folder-controls label {
            color: #666;
        }
        
        .folder-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .folder-input-group input {
            flex: 1;
            margin: 0;
        }
        
        .button.small {
            padding: 6px 12px;
            font-size: 12px;
            min-width: auto;
        }
        
        .upload-hint {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }
        
        body.light-mode .upload-hint {
            color: #666;
        }
        
        .pdf-upload-area {
            border: 2px dashed #555;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #2a2a2a;
            margin-bottom: 15px;
        }
        
        body.light-mode .pdf-upload-area {
            border-color: #ddd;
            background: #f8f9fa;
        }
        
        .pdf-upload-area:hover {
            border-color: #0066cc;
            background: #333;
        }
        
        body.light-mode .pdf-upload-area:hover {
            border-color: #0066cc;
            background: #e9ecef;
        }
        
        .pdf-upload-area.dragover {
            border-color: #0066cc;
            background: #1a3a1a;
            transform: scale(1.02);
        }
        
        body.light-mode .pdf-upload-area.dragover {
            background: #e8f5e8;
        }
        
        .pdf-list {
            margin-bottom: 15px;
        }
        
        .pdf-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #333;
            border: 1px solid #444;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        body.light-mode .pdf-item {
            background: #fff;
            border-color: #ddd;
        }
        
        .pdf-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .pdf-item-icon {
            color: #ff6b6b;
            font-size: 18px;
        }
        
        .pdf-item-details {
            flex: 1;
        }
        
        .pdf-item-name {
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 2px;
        }
        
        body.light-mode .pdf-item-name {
            color: #333;
        }
        
        .pdf-item-size {
            font-size: 12px;
            color: #999;
        }
        
        .pdf-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .pdf-action-btn {
            background: #444;
            border: none;
            color: #ccc;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .pdf-action-btn:hover {
            background: #555;
            color: #fff;
        }
        
        .pdf-action-btn.insert {
            background: #0066cc;
            color: #fff;
        }
        
        .pdf-action-btn.insert:hover {
            background: #0077ee;
        }
        
        .pdf-action-btn.delete {
            background: #dc3545;
            color: #fff;
        }
        
        .pdf-action-btn.delete:hover {
            background: #c82333;
        }
        
        /* PDF Modal Styles */
        .pdf-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .pdf-modal-content {
            background: #2a2a2a;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #444;
        }
        
        body.light-mode .pdf-modal-content {
            background: #fff;
            border-color: #ddd;
        }
        
        .pdf-management-list {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .pdf-management-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        body.light-mode .pdf-management-item {
            background: #f8f9fa;
            border-color: #ddd;
        }
        
        .pdf-management-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .pdf-management-details h4 {
            margin: 0 0 4px 0;
            color: #e0e0e0;
        }
        
        body.light-mode .pdf-management-details h4 {
            color: #333;
        }
        
        .pdf-management-details p {
            margin: 0;
            font-size: 12px;
            color: #999;
        }

        /* Scheduled Posts Styles */
        .scheduled-posts-section {
            margin-top: 10px;
        }

        .scheduled-posts-list {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .scheduled-post-item {
            background: #333;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.light-mode .scheduled-post-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
        }

        .scheduled-post-info {
            flex: 1;
        }

        .scheduled-post-title {
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 5px;
        }

        body.light-mode .scheduled-post-title {
            color: #333;
        }

        .scheduled-post-time {
            font-size: 12px;
            color: #999;
        }

        body.light-mode .scheduled-post-time {
            color: #666;
        }

        .scheduled-post-actions {
            display: flex;
            gap: 8px;
        }

        .scheduled-post-actions button {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }

        .no-scheduled-posts {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }

        body.light-mode .no-scheduled-posts {
            color: #666;
        }
        
        /* Date Calendar Styles */
        .date-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .datetime-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .datetime-inputs input[type="date"] {
            flex: 2;
        }
        
        .datetime-inputs input[type="time"] {
            flex: 1;
        }
        
        .date-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .date-presets .button {
            background: #444;
            border: 1px solid #555;
            color: #ccc;
            transition: all 0.2s ease;
        }
        
        .date-presets .button:hover {
            background: #555;
            color: #fff;
            border-color: #666;
        }
        
        body.light-mode .date-presets .button {
            background: #e9ecef;
            border-color: #ddd;
            color: #666;
        }
        
        body.light-mode         .date-presets .button:hover {
            background: #dee2e6;
            color: #333;
        }
        
        .time-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .time-presets .button {
            background: #444;
            border: 1px solid #555;
            color: #ccc;
            transition: all 0.2s ease;
        }
        
        .time-presets .button:hover {
            background: #555;
            color: #fff;
            border-color: #666;
        }
        
        body.light-mode .time-presets .button {
            background: #e9ecef;
            border-color: #ddd;
            color: #666;
        }
        
        body.light-mode .time-presets .button:hover {
            background: #dee2e6;
            color: #333;
        }
        
        .publication-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 8px 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
        }
        
        body.light-mode .publication-status {
            background: #f8f9fa;
            border-color: #ddd;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
        }
        
        .status-indicator.scheduled {
            background: #ff9800;
        }
        
        .status-indicator.past {
            background: #f44336;
        }
        
        .status-text {
            font-size: 12px;
            color: #ccc;
        }
        
        body.light-mode .status-text {
            color: #666;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .editor-container {
                padding: 15px;
            }
            
            .content-editor {
                flex-direction: column;
            }
            
            .header-controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .content-stats {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .stat-item {
                min-width: 80px;
            }
            
            .toolbar {
                gap: 2px;
                padding: 8px;
            }
            
            .toolbar-group {
                gap: 1px;
            }
            
            .toolbar-separator {
                margin: 0 4px;
            }
            
            .toolbar-btn {
                min-width: 28px;
                height: 28px;
                padding: 6px;
            }
            
            .toolbar-btn i {
                font-size: 12px;
            }
            
            .pdf-modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
            
            .folder-input-group {
                flex-direction: column;
                gap: 8px;
            }
            
            .date-presets {
                gap: 6px;
            }
            
            .date-presets .button {
                font-size: 11px;
                padding: 4px 8px;
            }
            
            .datetime-inputs {
                flex-direction: column;
                gap: 8px;
            }
            
            .datetime-inputs input[type="date"],
            .datetime-inputs input[type="time"] {
                flex: none;
                width: 100%;
            }
            
            .time-presets {
                gap: 6px;
            }
            
            .time-presets .button {
                font-size: 11px;
                padding: 4px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="header">
            <h1>New Post</h1>
            <div class="header-controls">
                <div class="save-status idle" id="saveStatus">
                    <i class="fas fa-circle"></i> All changes saved
                </div>
                <button class="preview-toggle" id="previewToggle">
                    <i class="fas fa-eye"></i> Preview
                </button>
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-sun"></i> Light Mode
                </button>
            </div>
        </div>
        
        <form id="postForm">
            <div class="form-group">
                <label for="postTitle">Title</label>
                <input type="text" id="postTitle" placeholder="Enter your post title..." required>
            </div>
            
            <div class="form-group">
                <label>Tags</label>
                <div class="tags-input" id="tagsInput">
                    <input type="text" class="tag-input" id="tagInput" placeholder="Add tags...">
                </div>
            </div>
            
            <div class="form-group">
                <label for="postContent">Content</label>
                <div class="content-stats" id="contentStats">
                    <div class="stat-item">
                        <i class="fas fa-font"></i>
                        <span class="stat-value word-count" id="wordCount">0</span>
                        <span class="stat-label">words</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <span class="stat-value reading-time" id="readingTime">0 min</span>
                        <span class="stat-label">read</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-text-width"></i>
                        <span class="stat-value char-count" id="charCount">0</span>
                        <span class="stat-label">characters</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-paragraph"></i>
                        <span class="stat-value" id="paragraphCount">0</span>
                        <span class="stat-label">paragraphs</span>
                    </div>
                </div>
                <div class="content-editor">
                    <div class="editor-panel">
                        <div class="toolbar">
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="Bold (Ctrl+B)">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="Italic (Ctrl+I)">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="formatText('strikethrough')" title="Strikethrough (Ctrl+S)">
                                    <i class="fas fa-strikethrough"></i>
                                </button>
                            </div>
                            
                            <div class="toolbar-separator"></div>
                            
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" onclick="openLinkModal()" title="Insert Link (Ctrl+K)">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="openImageModal()" title="Insert Image">
                                    <i class="fas fa-image"></i>
                                </button>
                            </div>
                            
                            <div class="toolbar-separator"></div>
                            
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" onclick="formatText('quote')" title="Blockquote">
                                    <i class="fas fa-quote-left"></i>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="formatText('code')" title="Code Block (Ctrl+Shift+K)">
                                    <i class="fas fa-code"></i>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="formatText('table')" title="Insert Table">
                                    <i class="fas fa-table"></i>
                                </button>
                            </div>
                            
                            <div class="toolbar-separator"></div>
                            
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" onclick="formatText('list')" title="Bullet List">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="formatText('numberedList')" title="Numbered List">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="formatText('header')" title="Header (Ctrl+H)">
                                    <i class="fas fa-heading"></i>
                                </button>
                            </div>
                            
                            <div class="toolbar-separator"></div>
                            
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" onclick="undoAction()" title="Undo (Ctrl+Z)">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="redoAction()" title="Redo (Ctrl+Y)">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="openFindReplace()" title="Find & Replace (Ctrl+F)">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="clearFormatting()" title="Clear Formatting">
                                    <i class="fas fa-eraser"></i>
                                </button>
                            </div>
                        </div>
                        <textarea id="postContent" placeholder="Write your content here...&#10;&#10;Use markdown formatting:&#10;**bold text**&#10;*italic text*&#10;[link text](url)&#10;> blockquote&#10;`code`&#10;- list item" required></textarea>
                    </div>
                    <div class="preview-panel" id="previewPanel">
                        <div class="preview-content" id="previewContent">
                            <p style="color: #666; font-style: italic;">Preview will appear here as you type...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="postCategory">Category</label>
                    <select id="postCategory">
                        <option value="general">General</option>
                        <option value="finance">Finance</option>
                        <option value="housing">Housing</option>
                        <option value="economics">Economics</option>
                        <option value="technology">Technology</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="postDate">Publication Date & Time</label>
                    <div class="date-controls">
                        <div class="datetime-inputs">
                            <input type="date" id="postDate">
                            <input type="time" id="postTime" value="09:00">
                        </div>
                        <div class="date-presets">
                            <button type="button" class="button small" onclick="setDate('today')">Today</button>
                            <button type="button" class="button small" onclick="setDate('tomorrow')">Tomorrow</button>
                            <button type="button" class="button small" onclick="setDate('next-week')">Next Week</button>
                            <button type="button" class="button small" onclick="setDate('next-month')">Next Month</button>
                        </div>
                        <div class="time-presets">
                            <button type="button" class="button small" onclick="setTime('morning')">Morning (9 AM)</button>
                            <button type="button" class="button small" onclick="setTime('noon')">Noon (12 PM)</button>
                            <button type="button" class="button small" onclick="setTime('evening')">Evening (6 PM)</button>
                            <button type="button" class="button small" onclick="setTime('night')">Night (9 PM)</button>
                        </div>
                    </div>
                    <div class="publication-status" id="publicationStatus">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span class="status-text" id="statusText">Ready to publish</span>
                    </div>
                </div>
            </div>
            
            <!-- SEO Section -->
            <div class="seo-section">
                <h3><i class="fas fa-search"></i> SEO Optimization</h3>
                <div class="seo-grid">
                    <div class="seo-item">
                        <label for="metaDescription">Meta Description</label>
                        <textarea id="metaDescription" placeholder="Enter a compelling description for search engines (150-160 characters recommended)..." rows="3"></textarea>
                        <div class="seo-counter">
                            <span id="metaDescriptionCount">0</span>/160 characters
                        </div>
                    </div>
                    
                    <div class="seo-item">
                        <label for="seoKeywords">Focus Keywords</label>
                        <input type="text" id="seoKeywords" placeholder="Enter primary keywords separated by commas...">
                        <div class="keyword-tags" id="keywordTags"></div>
                    </div>
                    
                    <div class="seo-item">
                        <label for="urlSlug">URL Slug</label>
                        <input type="text" id="urlSlug" placeholder="post-url-slug">
                        <div class="url-preview">
                            <span class="url-prefix">roberttolan.com/posts/</span>
                            <span id="urlPreview">your-post-slug</span>
                        </div>
                    </div>
                </div>
                
                <div class="seo-analysis" id="seoAnalysis">
                    <h4><i class="fas fa-chart-line"></i> SEO Analysis</h4>
                    <div class="seo-metrics">
                        <div class="seo-metric">
                            <div class="metric-icon">
                                <i class="fas fa-check-circle" id="titleScoreIcon"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-title">Title Length</div>
                                <div class="metric-value" id="titleScore">Good (45/60)</div>
                            </div>
                        </div>
                        
                        <div class="seo-metric">
                            <div class="metric-icon">
                                <i class="fas fa-check-circle" id="descriptionScoreIcon"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-title">Meta Description</div>
                                <div class="metric-value" id="descriptionScore">Missing</div>
                            </div>
                        </div>
                        
                        <div class="seo-metric">
                            <div class="metric-icon">
                                <i class="fas fa-check-circle" id="keywordScoreIcon"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-title">Keyword Usage</div>
                                <div class="metric-value" id="keywordScore">No keywords set</div>
                            </div>
                        </div>
                        
                        <div class="seo-metric">
                            <div class="metric-icon">
                                <i class="fas fa-check-circle" id="contentScoreIcon"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-title">Content Length</div>
                                <div class="metric-value" id="contentScore">Good (150 words)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="seo-suggestions" id="seoSuggestions">
                        <h5>Suggestions</h5>
                        <ul id="seoSuggestionsList">
                            <li>Add a meta description to improve search results</li>
                            <li>Include focus keywords in your content</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- PDF Upload Section -->
            <div class="form-group">
                <label>PDF Documents</label>
                <div class="pdf-upload-section">
                    <div class="pdf-folder-controls">
                        <label for="pdfFolder">PDF Folder:</label>
                        <div class="folder-input-group">
                            <input type="text" id="pdfFolder" placeholder="Enter folder name (e.g., derivatives, housing, research)" value="misc">
                            <button type="button" class="button small" id="createFolderBtn">
                                <i class="fas fa-folder-plus"></i> Create
                            </button>
                        </div>
                    </div>
                    <div class="pdf-upload-area" id="pdfUploadArea">
                        <p><i class="fas fa-file-pdf" style="font-size: 24px; margin-bottom: 10px;"></i></p>
                        <p>Click to upload PDF or drag files here</p>
                        <p class="upload-hint">Files will be saved to: <strong>docs/<span id="currentFolder">misc</span>/</strong></p>
                        <input type="file" id="pdfInput" accept=".pdf" multiple style="display: none;">
                    </div>
                    <div class="pdf-list" id="pdfList">
                        <!-- Uploaded PDFs will appear here -->
                    </div>
                    <button type="button" class="button" id="managePdfBtn">
                        <i class="fas fa-cog"></i> Manage PDFs
                    </button>
                </div>
            </div>

            <!-- Scheduled Posts Section -->
            <div class="form-group">
                <label>Scheduled Posts</label>
                <div class="scheduled-posts-section">
                    <button type="button" class="button secondary" onclick="loadScheduledPosts()">
                        <i class="fas fa-refresh"></i> Refresh Scheduled Posts
                    </button>
                    <div id="scheduledPostsList" class="scheduled-posts-list">
                        <p class="text-muted">Click "Refresh" to load scheduled posts</p>
                    </div>
                </div>
            </div>
            
            <div class="publish-section">
                <div class="publish-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="sendNewsletter" checked>
                        <span class="checkmark"></span>
                        Send to newsletter subscribers
                    </label>
                </div>
                <button type="submit" class="button primary" id="submitBtn">
                    <i class="fas fa-paper-plane"></i> Publish Post
                </button>
            </div>
        </form>
        
        <div class="success-message" id="successMessage">
            <i class="fas fa-check-circle"></i> Post published successfully! RSS feed updated automatically.
        </div>
        
        <div class="error-message" id="errorMessage">
            <i class="fas fa-exclamation-circle"></i> Error publishing post. Please try again.
        </div>
    </div>

    <!-- Image Insert Modal -->
    <div class="image-modal" id="imageModal">
        <div class="image-modal-content">
            <h3><i class="fas fa-image"></i> Insert Image</h3>
            <div class="image-upload-area" id="modalImageUpload">
                <p><i class="fas fa-cloud-upload-alt" style="font-size: 24px; margin-bottom: 10px;"></i></p>
                <p>Click to upload or drag image here</p>
                <input type="file" id="modalImageInput" accept="image/*" style="display: none;">
            </div>
            <div class="image-preview" id="modalImagePreview" style="display: none;">
                <img id="modalPreviewImg" src="" alt="Preview">
            </div>
            <button type="button" class="button primary" id="insertImageBtn" style="display: none;">
                <i class="fas fa-plus"></i> Insert Image
            </button>
            <button type="button" class="button" onclick="closeImageModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>

    <!-- Link Insert Modal -->
    <div class="link-modal" id="linkModal">
        <div class="link-modal-content">
            <h3><i class="fas fa-link"></i> Insert Link</h3>
            <div class="form-group">
                <label for="linkText">Link Text</label>
                <input type="text" id="linkText" placeholder="Text to display for the link...">
            </div>
            <div class="form-group">
                <label for="linkUrl">URL</label>
                <input type="url" id="linkUrl" placeholder="https://example.com">
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="linkNewTab">
                    <span class="checkmark"></span>
                    Open in new tab
                </label>
            </div>
            <div class="link-preview" id="linkPreview" style="display: none;">
                <p><strong>Preview:</strong> <span id="linkPreviewText"></span></p>
            </div>
            <div class="modal-buttons">
                <button type="button" class="button primary" id="insertLinkBtn">
                    <i class="fas fa-plus"></i> Insert Link
                </button>
                <button type="button" class="button" onclick="closeLinkModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Find & Replace Modal -->
    <div class="find-modal" id="findModal">
        <div class="find-modal-content">
            <h3><i class="fas fa-search"></i> Find & Replace</h3>
            <div class="form-group">
                <label for="findText">Find</label>
                <input type="text" id="findText" placeholder="Text to find...">
            </div>
            <div class="form-group">
                <label for="replaceText">Replace with</label>
                <input type="text" id="replaceText" placeholder="Replacement text...">
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="findCaseSensitive">
                    <span class="checkmark"></span>
                    Case sensitive
                </label>
            </div>
            <div class="find-results" id="findResults" style="display: none;">
                <p><strong>Found:</strong> <span id="findCount">0</span> matches</p>
            </div>
            <div class="modal-buttons">
                <button type="button" class="button" onclick="findNext()">
                    <i class="fas fa-arrow-down"></i> Find Next
                </button>
                <button type="button" class="button" onclick="replaceCurrent()">
                    <i class="fas fa-exchange-alt"></i> Replace
                </button>
                <button type="button" class="button primary" onclick="replaceAll()">
                    <i class="fas fa-sync"></i> Replace All
                </button>
                <button type="button" class="button" onclick="closeFindModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- PDF Management Modal -->
    <div class="pdf-modal" id="pdfModal">
        <div class="pdf-modal-content">
            <h3><i class="fas fa-file-pdf"></i> Manage PDF Documents</h3>
            <div class="pdf-upload-area" id="modalPdfUpload">
                <p><i class="fas fa-cloud-upload-alt" style="font-size: 24px; margin-bottom: 10px;"></i></p>
                <p>Click to upload or drag PDF files here</p>
                <input type="file" id="modalPdfInput" accept=".pdf" multiple style="display: none;">
            </div>
            <div class="pdf-management-list" id="pdfManagementList">
                <!-- PDFs will be listed here -->
            </div>
            <div class="modal-buttons">
                <button type="button" class="button" onclick="closePdfModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <script src="js/post-manager.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/public-config.js"></script>
    <script src="js/supabase-newsletter.js"></script>
    <script>
        const postManager = new PostManager();
        const supabaseNewsletter = new SupabaseNewsletter();
        let currentImageData = null;
        let tags = [];
        
        // Configure marked.js for markdown parsing
        marked.setOptions({
            breaks: true,
            gfm: true
        });
        
        // Auto-save functionality
        let autoSaveInterval;
        let lastSavedContent = '';
        let isSaving = false;
        let currentDraftId = null;
        
        // Initialize auto-save
        function initAutoSave() {
            // Check for existing draft on page load
            checkForExistingDraft();
            
            // Start auto-save interval
            autoSaveInterval = setInterval(autoSaveDraft, 30000); // Save every 30 seconds
            
            // Save on form changes
            const formElements = ['postTitle', 'postContent', 'postCategory', 'postDate', 'postTime'];
            formElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => {
                        if (hasContentChanged()) {
                            scheduleAutoSave();
                        }
                    });
                }
            });
            
            // Save on tag changes
            tagInput.addEventListener('input', () => {
                if (hasContentChanged()) {
                    scheduleAutoSave();
                }
            });
        }
        
        // Check if content has changed since last save
        function hasContentChanged() {
            const currentContent = getFormData();
            return JSON.stringify(currentContent) !== lastSavedContent;
        }
        
        // Get current form data
        function getFormData() {
            return {
                title: document.getElementById('postTitle').value,
                content: document.getElementById('postContent').value,
                category: document.getElementById('postCategory').value,
                date: document.getElementById('postDate').value,
                time: document.getElementById('postTime').value,
                tags: tags,
                metaDescription: document.getElementById('metaDescription').value,
                urlSlug: document.getElementById('urlSlug').value,
                seoKeywords: seoKeywords,
                timestamp: new Date().toISOString()
            };
        }
        
        // Schedule auto-save (debounced)
        let saveTimeout;
        function scheduleAutoSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(autoSaveDraft, 2000); // Save 2 seconds after last change
        }
        
        // Auto-save draft to Supabase
        async function autoSaveDraft() {
            if (isSaving) return;
            
            const formData = getFormData();
            const contentString = JSON.stringify(formData);
            
            // Don't save if nothing has changed
            if (contentString === lastSavedContent) return;
            
            // Don't save empty drafts
            if (!formData.title.trim() && !formData.content.trim()) return;
            
            isSaving = true;
            updateSaveStatus('saving');
            
            try {
                const { data, error } = await supabase
                    .from('drafts')
                    .upsert({
                        id: currentDraftId,
                        title: formData.title,
                        content: formData.content,
                        category: formData.category,
                        date: formData.date,
                        tags: formData.tags,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'id'
                    })
                    .select();
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    currentDraftId = data[0].id;
                    lastSavedContent = contentString;
                    updateSaveStatus('saved');
                }
                
            } catch (error) {
                console.error('Auto-save error:', error);
                updateSaveStatus('error');
            } finally {
                isSaving = false;
            }
        }
        
        // Update save status indicator
        function updateSaveStatus(status) {
            const statusIndicator = document.getElementById('saveStatus');
            if (!statusIndicator) return;
            
            switch (status) {
                case 'saving':
                    statusIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                    statusIndicator.className = 'save-status saving';
                    break;
                case 'saved':
                    statusIndicator.innerHTML = '<i class="fas fa-check"></i> Saved';
                    statusIndicator.className = 'save-status saved';
                    setTimeout(() => {
                        statusIndicator.innerHTML = '<i class="fas fa-circle"></i> All changes saved';
                        statusIndicator.className = 'save-status idle';
                    }, 2000);
                    break;
                case 'error':
                    statusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Save failed';
                    statusIndicator.className = 'save-status error';
                    break;
                case 'idle':
                    statusIndicator.innerHTML = '<i class="fas fa-circle"></i> All changes saved';
                    statusIndicator.className = 'save-status idle';
                    break;
            }
        }
        
        // Check for existing draft on page load
        async function checkForExistingDraft() {
            try {
                const { data, error } = await supabase
                    .from('drafts')
                    .select('*')
                    .order('updated_at', { ascending: false })
                    .limit(1);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const draft = data[0];
                    const shouldRestore = confirm(
                        `Found a draft from ${new Date(draft.updated_at).toLocaleString()}.\n\n` +
                        `Title: ${draft.title || 'Untitled'}\n\n` +
                        `Would you like to restore this draft?`
                    );
                    
                    if (shouldRestore) {
                        restoreDraft(draft);
                    } else {
                        // Delete the old draft
                        await supabase.from('drafts').delete().eq('id', draft.id);
                    }
                }
            } catch (error) {
                console.error('Error checking for drafts:', error);
            }
        }
        
        // Restore draft content
        function restoreDraft(draft) {
            document.getElementById('postTitle').value = draft.title || '';
            document.getElementById('postContent').value = draft.content || '';
            document.getElementById('postCategory').value = draft.category || 'general';
            document.getElementById('postDate').value = draft.date || new Date().toISOString().split('T')[0];
            
            // Restore SEO data
            document.getElementById('metaDescription').value = draft.metaDescription || '';
            document.getElementById('urlSlug').value = draft.urlSlug || '';
            seoKeywords = draft.seoKeywords || [];
            renderKeywords();
            
            tags = draft.tags || [];
            renderTags();
            
            currentDraftId = draft.id;
            lastSavedContent = JSON.stringify(getFormData());
            
            updatePreview();
            updateContentStats();
            updateSEOAnalysis();
            updateSaveStatus('saved');
        }
        
        // Clear draft when post is published
        async function clearDraft() {
            if (currentDraftId) {
                try {
                    await supabase.from('drafts').delete().eq('id', currentDraftId);
                    currentDraftId = null;
                    lastSavedContent = '';
                } catch (error) {
                    console.error('Error clearing draft:', error);
                }
            }
        }
        
        // Initialize auto-save when page loads
        document.addEventListener('DOMContentLoaded', initAutoSave);
        
        // SEO functionality
        let seoKeywords = [];
        
        // Initialize SEO tools
        function initSEO() {
            // Meta description counter
            document.getElementById('metaDescription').addEventListener('input', function() {
                const count = this.value.length;
                document.getElementById('metaDescriptionCount').textContent = count;
                
                if (count > 160) {
                    document.getElementById('metaDescriptionCount').style.color = '#f44336';
                } else if (count > 120) {
                    document.getElementById('metaDescriptionCount').style.color = '#ff9800';
                } else {
                    document.getElementById('metaDescriptionCount').style.color = '#4caf50';
                }
                
                updateSEOAnalysis();
            });
            
            // Keywords management
            document.getElementById('seoKeywords').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const keyword = this.value.trim();
                    if (keyword && !seoKeywords.includes(keyword)) {
                        addKeyword(keyword);
                    }
                    this.value = '';
                }
            });
            
            // URL slug generation
            document.getElementById('postTitle').addEventListener('input', function() {
                generateURLSlug();
                updateSEOAnalysis();
            });
            
            document.getElementById('urlSlug').addEventListener('input', function() {
                updateURLPreview();
            });
            
            // Content analysis
            postContent.addEventListener('input', function() {
                updateSEOAnalysis();
            });
            
            // Initial analysis
            updateSEOAnalysis();
        }
        
        function addKeyword(keyword) {
            seoKeywords.push(keyword);
            renderKeywords();
            updateSEOAnalysis();
        }
        
        function removeKeyword(keyword) {
            seoKeywords = seoKeywords.filter(k => k !== keyword);
            renderKeywords();
            updateSEOAnalysis();
        }
        
        function renderKeywords() {
            const container = document.getElementById('keywordTags');
            container.innerHTML = '';
            
            seoKeywords.forEach(keyword => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.innerHTML = `
                    ${keyword}
                    <span class="remove-keyword" onclick="removeKeyword('${keyword}')">Ã—</span>
                `;
                container.appendChild(tag);
            });
        }
        
        function generateURLSlug() {
            const title = document.getElementById('postTitle').value;
            const slug = title
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-') // Replace multiple hyphens with single
                .trim('-'); // Remove leading/trailing hyphens
            
            document.getElementById('urlSlug').value = slug;
            updateURLPreview();
        }
        
        function updateURLPreview() {
            const slug = document.getElementById('urlSlug').value || 'your-post-slug';
            document.getElementById('urlPreview').textContent = slug;
        }
        
        function updateSEOAnalysis() {
            const title = document.getElementById('postTitle').value;
            const description = document.getElementById('metaDescription').value;
            const content = postContent.value;
            
            // Title analysis
            const titleLength = title.length;
            let titleScore, titleIcon, titleText;
            
            if (titleLength === 0) {
                titleScore = 'Missing';
                titleIcon = 'fa-times-circle';
                titleText = 'Add a title';
            } else if (titleLength < 30) {
                titleScore = 'Too Short';
                titleIcon = 'fa-exclamation-triangle';
                titleText = `${titleLength}/60 characters`;
            } else if (titleLength > 60) {
                titleScore = 'Too Long';
                titleIcon = 'fa-exclamation-triangle';
                titleText = `${titleLength}/60 characters`;
            } else {
                titleScore = 'Good';
                titleIcon = 'fa-check-circle';
                titleText = `${titleLength}/60 characters`;
            }
            
            // Description analysis
            const descLength = description.length;
            let descScore, descIcon, descText;
            
            if (descLength === 0) {
                descScore = 'Missing';
                descIcon = 'fa-times-circle';
                descText = 'Add a meta description';
            } else if (descLength < 120) {
                descScore = 'Too Short';
                descIcon = 'fa-exclamation-triangle';
                descText = `${descLength}/160 characters`;
            } else if (descLength > 160) {
                descScore = 'Too Long';
                descIcon = 'fa-exclamation-triangle';
                descText = `${descLength}/160 characters`;
            } else {
                descScore = 'Good';
                descIcon = 'fa-check-circle';
                descText = `${descLength}/160 characters`;
            }
            
            // Keyword analysis
            let keywordScore, keywordIcon, keywordText;
            
            if (seoKeywords.length === 0) {
                keywordScore = 'No keywords set';
                keywordIcon = 'fa-times-circle';
                keywordText = 'Add focus keywords';
            } else {
                const keywordUsage = analyzeKeywordUsage(content, seoKeywords);
                if (keywordUsage.score > 0.7) {
                    keywordScore = 'Good';
                    keywordIcon = 'fa-check-circle';
                } else if (keywordUsage.score > 0.3) {
                    keywordScore = 'Fair';
                    keywordIcon = 'fa-exclamation-triangle';
                } else {
                    keywordScore = 'Poor';
                    keywordIcon = 'fa-times-circle';
                }
                keywordText = `${keywordUsage.found}/${seoKeywords.length} keywords used`;
            }
            
            // Content length analysis
            const wordCount = calculateContentStats(content).words;
            let contentScore, contentIcon, contentText;
            
            if (wordCount < 300) {
                contentScore = 'Too Short';
                contentIcon = 'fa-exclamation-triangle';
                contentText = `${wordCount} words (aim for 300+)`;
            } else if (wordCount < 1000) {
                contentScore = 'Good';
                contentIcon = 'fa-check-circle';
                contentText = `${wordCount} words`;
            } else {
                contentScore = 'Excellent';
                contentIcon = 'fa-check-circle';
                contentText = `${wordCount} words`;
            }
            
            // Update UI
            document.getElementById('titleScoreIcon').className = `fas ${titleIcon}`;
            document.getElementById('titleScore').textContent = `${titleScore} (${titleText})`;
            
            document.getElementById('descriptionScoreIcon').className = `fas ${descIcon}`;
            document.getElementById('descriptionScore').textContent = `${descScore} (${descText})`;
            
            document.getElementById('keywordScoreIcon').className = `fas ${keywordIcon}`;
            document.getElementById('keywordScore').textContent = `${keywordScore} (${keywordText})`;
            
            document.getElementById('contentScoreIcon').className = `fas ${contentIcon}`;
            document.getElementById('contentScore').textContent = `${contentScore} (${contentText})`;
            
            // Generate suggestions
            generateSEOSuggestions();
        }
        
        function analyzeKeywordUsage(content, keywords) {
            const cleanContent = content.toLowerCase();
            let found = 0;
            
            keywords.forEach(keyword => {
                if (cleanContent.includes(keyword.toLowerCase())) {
                    found++;
                }
            });
            
            return {
                found: found,
                score: found / keywords.length
            };
        }
        
        function generateSEOSuggestions() {
            const suggestions = [];
            const title = document.getElementById('postTitle').value;
            const description = document.getElementById('metaDescription').value;
            const content = postContent.value;
            
            if (!title) {
                suggestions.push('Add a compelling title that includes your main keyword');
            }
            
            if (!description) {
                suggestions.push('Add a meta description to improve search result snippets');
            }
            
            if (seoKeywords.length === 0) {
                suggestions.push('Add focus keywords to target specific search terms');
            } else {
                const keywordUsage = analyzeKeywordUsage(content, seoKeywords);
                if (keywordUsage.score < 0.5) {
                    suggestions.push('Include more of your focus keywords in the content');
                }
            }
            
            if (content.length < 1000) {
                suggestions.push('Write longer content (aim for at least 300 words)');
            }
            
            if (title && title.length > 60) {
                suggestions.push('Shorten your title to under 60 characters');
            }
            
            if (description && description.length > 160) {
                suggestions.push('Shorten your meta description to under 160 characters');
            }
            
            const suggestionsList = document.getElementById('seoSuggestionsList');
            suggestionsList.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.textContent = suggestion;
                suggestionsList.appendChild(li);
            });
        }
        
        // Initialize SEO tools
        document.addEventListener('DOMContentLoaded', initSEO);
        
        // Generate individual post page
        async function generatePostPage(title, content, options) {
            try {
                // Call Netlify function to generate post
                const response = await fetch('/.netlify/functions/generate-post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        options: options
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    const successMessage = document.createElement('div');
                    successMessage.style.cssText = `
                        background: #4caf50;
                        color: white;
                        padding: 15px;
                        border-radius: 6px;
                        margin-top: 15px;
                        text-align: center;
                        font-weight: 500;
                    `;
                    successMessage.innerHTML = `
                        <i class="fas fa-check-circle"></i> 
                        Post generated successfully! 
                        <a href="${result.postUrl}" target="_blank" style="color: white; text-decoration: underline; margin-left: 10px;">
                            View Post
                        </a>
                    `;
                    
                    const publishSection = document.querySelector('.publish-section');
                    publishSection.appendChild(successMessage);
                    
                    console.log('Post page generated successfully!', result);
                } else {
                    throw new Error(result.error || 'Failed to generate post');
                }
                
            } catch (error) {
                console.error('Error generating post page:', error);
                
                // Show error message
                const errorMessage = document.createElement('div');
                errorMessage.style.cssText = `
                    background: #f44336;
                    color: white;
                    padding: 15px;
                    border-radius: 6px;
                    margin-top: 15px;
                    text-align: center;
                    font-weight: 500;
                `;
                errorMessage.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i> 
                    Error generating post: ${error.message}
                `;
                
                const publishSection = document.querySelector('.publish-section');
                publishSection.appendChild(errorMessage);
            }
        }
        
        // Enhanced toolbar functionality
        let undoStack = [];
        let redoStack = [];
        let currentFindIndex = -1;
        let findMatches = [];
        
        // Track changes for undo/redo
        function saveState() {
            const currentState = postContent.value;
            undoStack.push(currentState);
            redoStack = []; // Clear redo stack when new action is performed
            if (undoStack.length > 50) undoStack.shift(); // Limit stack size
        }
        
        // Undo functionality
        function undoAction() {
            if (undoStack.length > 0) {
                const currentState = postContent.value;
                redoStack.push(currentState);
                const previousState = undoStack.pop();
                postContent.value = previousState;
                updatePreview();
                updateContentStats();
            }
        }
        
        // Redo functionality
        function redoAction() {
            if (redoStack.length > 0) {
                const currentState = postContent.value;
                undoStack.push(currentState);
                const nextState = redoStack.pop();
                postContent.value = nextState;
                updatePreview();
                updateContentStats();
            }
        }
        
        // Find & Replace functionality
        function openFindReplace() {
            document.getElementById('findModal').style.display = 'block';
            document.getElementById('findText').focus();
            currentFindIndex = -1;
            findMatches = [];
        }
        
        function closeFindModal() {
            document.getElementById('findModal').style.display = 'none';
            document.getElementById('findResults').style.display = 'none';
        }
        
        function findNext() {
            const findText = document.getElementById('findText').value;
            const caseSensitive = document.getElementById('findCaseSensitive').checked;
            
            if (!findText) return;
            
            const content = postContent.value;
            const flags = caseSensitive ? 'g' : 'gi';
            const regex = new RegExp(escapeRegExp(findText), flags);
            
            findMatches = [];
            let match;
            while ((match = regex.exec(content)) !== null) {
                findMatches.push(match.index);
            }
            
            if (findMatches.length > 0) {
                currentFindIndex = (currentFindIndex + 1) % findMatches.length;
                const matchIndex = findMatches[currentFindIndex];
                
                postContent.focus();
                postContent.setSelectionRange(matchIndex, matchIndex + findText.length);
                
                document.getElementById('findCount').textContent = findMatches.length;
                document.getElementById('findResults').style.display = 'block';
            } else {
                document.getElementById('findResults').style.display = 'none';
            }
        }
        
        function replaceCurrent() {
            const findText = document.getElementById('findText').value;
            const replaceText = document.getElementById('replaceText').value;
            
            if (!findText || currentFindIndex === -1) return;
            
            const matchIndex = findMatches[currentFindIndex];
            const content = postContent.value;
            const newContent = content.substring(0, matchIndex) + replaceText + content.substring(matchIndex + findText.length);
            
            postContent.value = newContent;
            updatePreview();
            updateContentStats();
            
            // Update find matches
            findMatches.splice(currentFindIndex, 1);
            if (findMatches.length === 0) {
                document.getElementById('findResults').style.display = 'none';
                currentFindIndex = -1;
            } else {
                currentFindIndex = currentFindIndex % findMatches.length;
                document.getElementById('findCount').textContent = findMatches.length;
            }
        }
        
        function replaceAll() {
            const findText = document.getElementById('findText').value;
            const replaceText = document.getElementById('replaceText').value;
            const caseSensitive = document.getElementById('findCaseSensitive').checked;
            
            if (!findText) return;
            
            const content = postContent.value;
            const flags = caseSensitive ? 'g' : 'gi';
            const regex = new RegExp(escapeRegExp(findText), flags);
            const newContent = content.replace(regex, replaceText);
            
            postContent.value = newContent;
            updatePreview();
            updateContentStats();
            
            document.getElementById('findResults').style.display = 'none';
            currentFindIndex = -1;
            findMatches = [];
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function clearFormatting() {
            const textarea = postContent;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            // Remove markdown formatting
            const cleanText = selectedText
                .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold
                .replace(/\*(.*?)\*/g, '$1') // Remove italic
                .replace(/~~(.*?)~~/g, '$1') // Remove strikethrough
                .replace(/`([^`]+)`/g, '$1') // Remove inline code
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1'); // Remove links
            
            textarea.value = textarea.value.substring(0, start) + cleanText + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start, start + cleanText.length);
            
            updatePreview();
            updateContentStats();
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Only handle shortcuts when textarea is focused
            if (document.activeElement !== postContent) return;
            
            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'b':
                        e.preventDefault();
                        formatText('bold');
                        break;
                    case 'i':
                        e.preventDefault();
                        formatText('italic');
                        break;
                    case 'k':
                        e.preventDefault();
                        openLinkModal();
                        break;
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) {
                            redoAction();
                        } else {
                            undoAction();
                        }
                        break;
                    case 'y':
                        e.preventDefault();
                        redoAction();
                        break;
                    case 'f':
                        e.preventDefault();
                        openFindReplace();
                        break;
                    case 's':
                        e.preventDefault();
                        if (e.shiftKey) {
                            formatText('strikethrough');
                        }
                        break;
                    case 'h':
                        e.preventDefault();
                        formatText('header');
                        break;
                }
            }
            
            // Ctrl+Shift+K for code block
            if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'k') {
                e.preventDefault();
                formatText('code');
            }
        });
        
        // Set default date to today
        document.getElementById('postDate').value = new Date().toISOString().split('T')[0];
        
        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        
        // Check for saved theme preference or default to dark mode
        const savedTheme = localStorage.getItem('adminTheme') || 'dark';
        if (savedTheme === 'light') {
            body.classList.add('light-mode');
            updateThemeButton('dark');
        }
        
        themeToggle.addEventListener('click', () => {
            if (body.classList.contains('light-mode')) {
                body.classList.remove('light-mode');
                localStorage.setItem('adminTheme', 'dark');
                updateThemeButton('light');
            } else {
                body.classList.add('light-mode');
                localStorage.setItem('adminTheme', 'light');
                updateThemeButton('dark');
            }
        });
        
        function updateThemeButton(mode) {
            if (mode === 'light') {
                themeToggle.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            } else {
                themeToggle.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
            }
        }
        
        // Preview toggle functionality
        const previewToggle = document.getElementById('previewToggle');
        const previewPanel = document.getElementById('previewPanel');
        const postContent = document.getElementById('postContent');
        const previewContent = document.getElementById('previewContent');
        
        previewToggle.addEventListener('click', () => {
            previewPanel.classList.toggle('active');
            previewToggle.classList.toggle('active');
            
            if (previewPanel.classList.contains('active')) {
                previewToggle.innerHTML = '<i class="fas fa-edit"></i> Edit';
                updatePreview();
            } else {
                previewToggle.innerHTML = '<i class="fas fa-eye"></i> Preview';
            }
        });
        
        // Live preview update
        postContent.addEventListener('input', () => {
            if (previewPanel.classList.contains('active')) {
                updatePreview();
            }
            updateContentStats();
        });
        
        function updatePreview() {
            const markdown = postContent.value;
            if (markdown.trim()) {
                const html = marked.parse(markdown);
                previewContent.innerHTML = html;
            } else {
                previewContent.innerHTML = '<p style="color: #666; font-style: italic;">Preview will appear here as you type...</p>';
            }
        }
        
        // Content statistics calculation
        function updateContentStats() {
            const content = postContent.value;
            const stats = calculateContentStats(content);
            
            document.getElementById('wordCount').textContent = stats.words;
            document.getElementById('readingTime').textContent = stats.readingTime;
            document.getElementById('charCount').textContent = stats.characters;
            document.getElementById('paragraphCount').textContent = stats.paragraphs;
        }
        
        function calculateContentStats(content) {
            if (!content.trim()) {
                return {
                    words: 0,
                    readingTime: '0 min',
                    characters: 0,
                    paragraphs: 0
                };
            }
            
            // Remove markdown syntax for more accurate counting
            const cleanContent = content
                .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold
                .replace(/\*(.*?)\*/g, '$1') // Remove italic
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Remove links
                .replace(/`([^`]+)`/g, '$1') // Remove inline code
                .replace(/```[\s\S]*?```/g, '') // Remove code blocks
                .replace(/>\s*(.*)/g, '$1') // Remove blockquotes
                .replace(/^#+\s*(.*)/gm, '$1') // Remove headers
                .replace(/^-\s*(.*)/gm, '$1') // Remove list markers
                .replace(/^[0-9]+\.\s*(.*)/gm, '$1'); // Remove numbered lists
            
            // Calculate statistics
            const words = cleanContent.trim().split(/\s+/).filter(word => word.length > 0).length;
            const characters = content.length;
            const paragraphs = content.split(/\n\s*\n/).filter(para => para.trim().length > 0).length;
            
            // Reading time calculation (average 200-250 words per minute)
            const wordsPerMinute = 225;
            const readingMinutes = Math.ceil(words / wordsPerMinute);
            const readingTime = readingMinutes === 0 ? '0 min' : 
                               readingMinutes === 1 ? '1 min' : 
                               `${readingMinutes} min`;
            
            return {
                words,
                readingTime,
                characters,
                paragraphs
            };
        }
        
        // Tag management
        const tagInput = document.getElementById('tagInput');
        const tagsInput = document.getElementById('tagsInput');
        
        tagInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const tag = tagInput.value.trim();
                if (tag && !tags.includes(tag)) {
                    addTag(tag);
                }
                tagInput.value = '';
            }
        });
        
        function addTag(tag) {
            tags.push(tag);
            const tagElement = document.createElement('div');
            tagElement.className = 'tag';
            tagElement.innerHTML = `
                ${tag}
                <span class="remove-tag" onclick="removeTag('${tag}')">Ã—</span>
            `;
            tagsInput.insertBefore(tagElement, tagInput);
        }
        
        function removeTag(tag) {
            tags = tags.filter(t => t !== tag);
            renderTags();
        }
        
        function renderTags() {
            const tagElements = tagsInput.querySelectorAll('.tag');
            tagElements.forEach(el => el.remove());
            
            tags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'tag';
                tagElement.innerHTML = `
                    ${tag}
                    <span class="remove-tag" onclick="removeTag('${tag}')">Ã—</span>
                `;
                tagsInput.insertBefore(tagElement, tagInput);
            });
        }
        
        // Enhanced text formatting functions
        function formatText(type) {
            const textarea = document.getElementById('postContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            let replacement = '';
            switch(type) {
                case 'bold':
                    replacement = `**${selectedText}**`;
                    break;
                case 'italic':
                    replacement = `*${selectedText}*`;
                    break;
                case 'strikethrough':
                    replacement = `~~${selectedText}~~`;
                    break;
                case 'link':
                    // This is now handled by the link modal
                    openLinkModal();
                    return;
                case 'quote':
                    replacement = `> ${selectedText}`;
                    break;
                case 'code':
                    if (selectedText.includes('\n')) {
                        replacement = `\`\`\`\n${selectedText}\n\`\`\``;
                    } else {
                        replacement = `\`${selectedText}\``;
                    }
                    break;
                case 'table':
                    replacement = createTableTemplate();
                    break;
                case 'list':
                    if (selectedText) {
                        const lines = selectedText.split('\n');
                        replacement = lines.map(line => `- ${line}`).join('\n');
                    } else {
                        replacement = '- ';
                    }
                    break;
                case 'numberedList':
                    if (selectedText) {
                        const lines = selectedText.split('\n');
                        replacement = lines.map((line, index) => `${index + 1}. ${line}`).join('\n');
                    } else {
                        replacement = '1. ';
                    }
                    break;
                case 'header':
                    replacement = `# ${selectedText}`;
                    break;
            }
            
            textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + replacement.length, start + replacement.length);
            
            // Save state for undo/redo
            saveState();
            
            // Update preview if active
            if (previewPanel.classList.contains('active')) {
                updatePreview();
            }
            
            updateContentStats();
        }
        
        function createTableTemplate() {
            return `| Header 1 | Header 2 | Header 3 |
|----------|----------|----------|
| Cell 1   | Cell 2   | Cell 3   |
| Cell 4   | Cell 5   | Cell 6   |`;
        }
        
        // Image modal functions
        function openImageModal() {
            document.getElementById('imageModal').style.display = 'block';
            currentImageData = null;
            document.getElementById('modalImagePreview').style.display = 'none';
            document.getElementById('insertImageBtn').style.display = 'none';
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }
        
        // Link modal functions
        function openLinkModal() {
            const textarea = document.getElementById('postContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            // Pre-fill link text with selected text
            document.getElementById('linkText').value = selectedText;
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkNewTab').checked = false;
            
            // Show modal
            document.getElementById('linkModal').style.display = 'block';
            
            // Focus on URL field
            setTimeout(() => {
                document.getElementById('linkUrl').focus();
            }, 100);
        }
        
        function closeLinkModal() {
            document.getElementById('linkModal').style.display = 'none';
            document.getElementById('linkPreview').style.display = 'none';
        }
        
        // Link preview functionality
        document.getElementById('linkText').addEventListener('input', updateLinkPreview);
        document.getElementById('linkUrl').addEventListener('input', updateLinkPreview);
        
        function updateLinkPreview() {
            const linkText = document.getElementById('linkText').value;
            const linkUrl = document.getElementById('linkUrl').value;
            const preview = document.getElementById('linkPreview');
            const previewText = document.getElementById('linkPreviewText');
            
            if (linkText && linkUrl) {
                previewText.innerHTML = `<a href="${linkUrl}" target="_blank">${linkText}</a>`;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }
        
        // Image upload handling
        const modalImageUpload = document.getElementById('modalImageUpload');
        const modalImageInput = document.getElementById('modalImageInput');
        const modalImagePreview = document.getElementById('modalImagePreview');
        const modalPreviewImg = document.getElementById('modalPreviewImg');
        const insertImageBtn = document.getElementById('insertImageBtn');
        
        modalImageUpload.addEventListener('click', () => modalImageInput.click());
        
        modalImageUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            modalImageUpload.classList.add('dragover');
        });
        
        modalImageUpload.addEventListener('dragleave', () => {
            modalImageUpload.classList.remove('dragover');
        });
        
        modalImageUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            modalImageUpload.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleModalImageUpload(files[0]);
            }
        });
        
        modalImageInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleModalImageUpload(e.target.files[0]);
            }
        });
        
        function handleModalImageUpload(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                modalPreviewImg.src = currentImageData;
                modalImagePreview.style.display = 'block';
                insertImageBtn.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        
        // Insert image into content
        insertImageBtn.addEventListener('click', () => {
            if (currentImageData) {
                const textarea = document.getElementById('postContent');
                const cursorPos = textarea.selectionStart;
                const imageMarkdown = `\n\n![Image](${currentImageData})\n\n`;
                
                textarea.value = textarea.value.substring(0, cursorPos) + imageMarkdown + textarea.value.substring(cursorPos);
                textarea.focus();
                textarea.setSelectionRange(cursorPos + imageMarkdown.length, cursorPos + imageMarkdown.length);
                
                // Update preview if active
                if (previewPanel.classList.contains('active')) {
                    updatePreview();
                }
                
                closeImageModal();
            }
        });
        
        // Insert link into content
        document.getElementById('insertLinkBtn').addEventListener('click', () => {
            const linkText = document.getElementById('linkText').value.trim();
            const linkUrl = document.getElementById('linkUrl').value.trim();
            const openNewTab = document.getElementById('linkNewTab').checked;
            
            if (!linkText || !linkUrl) {
                alert('Please enter both link text and URL');
                return;
            }
            
            const textarea = document.getElementById('postContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            
            // Create markdown link with optional target
            let linkMarkdown;
            if (openNewTab) {
                // For new tab, we'll need to handle this in the preview rendering
                linkMarkdown = `[${linkText}](${linkUrl}){:target="_blank"}`;
            } else {
                linkMarkdown = `[${linkText}](${linkUrl})`;
            }
            
            // Replace selected text or insert at cursor
            if (start !== end) {
                textarea.value = textarea.value.substring(0, start) + linkMarkdown + textarea.value.substring(end);
                textarea.setSelectionRange(start + linkMarkdown.length, start + linkMarkdown.length);
            } else {
                textarea.value = textarea.value.substring(0, start) + linkMarkdown + textarea.value.substring(start);
                textarea.setSelectionRange(start + linkMarkdown.length, start + linkMarkdown.length);
            }
            
            textarea.focus();
            
            // Update preview if active
            if (previewPanel.classList.contains('active')) {
                updatePreview();
            }
            
            closeLinkModal();
        });
        

        
        function clearForm() {
            document.getElementById('postForm').reset();
            const today = new Date();
            const localDate = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            document.getElementById('postDate').value = localDate;
            document.getElementById('postTime').value = '09:00';
            tags = [];
            seoKeywords = [];
            uploadedPdfs = [];
            currentPdfFolder = 'misc';
            pdfFolderInput.value = 'misc';
            updateCurrentFolder();
            updatePublicationStatus();
            renderTags();
            renderKeywords();
            renderPdfList();
            updatePreview();
            updateContentStats();
            updateSEOAnalysis();
        }
        
        // Close modals when clicking outside
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target.id === 'imageModal') {
                closeImageModal();
            }
        });
        
        document.getElementById('linkModal').addEventListener('click', (e) => {
            if (e.target.id === 'linkModal') {
                closeLinkModal();
            }
        });
        
        document.getElementById('findModal').addEventListener('click', (e) => {
            if (e.target.id === 'findModal') {
                closeFindModal();
            }
        });
        
        // PDF Upload and Management
        let uploadedPdfs = [];
        let currentPdfFolder = 'misc';
        
        // PDF upload area functionality
        const pdfUploadArea = document.getElementById('pdfUploadArea');
        const pdfInput = document.getElementById('pdfInput');
        const pdfList = document.getElementById('pdfList');
        const managePdfBtn = document.getElementById('managePdfBtn');
        
        // Modal elements
        const pdfModal = document.getElementById('pdfModal');
        const modalPdfUpload = document.getElementById('modalPdfUpload');
        const modalPdfInput = document.getElementById('modalPdfInput');
        const pdfManagementList = document.getElementById('pdfManagementList');
        
        // Folder controls
        const pdfFolderInput = document.getElementById('pdfFolder');
        const createFolderBtn = document.getElementById('createFolderBtn');
        const currentFolderSpan = document.getElementById('currentFolder');
        
        // Date controls
        const postDateInput = document.getElementById('postDate');
        const postTimeInput = document.getElementById('postTime');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        
        // PDF upload area event listeners
        pdfUploadArea.addEventListener('click', () => pdfInput.click());
        pdfUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            pdfUploadArea.classList.add('dragover');
        });
        pdfUploadArea.addEventListener('dragleave', () => {
            pdfUploadArea.classList.remove('dragover');
        });
        pdfUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            pdfUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handlePdfUpload(Array.from(files));
        });
        
        pdfInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handlePdfUpload(files);
        });
        
        // Modal PDF upload event listeners
        modalPdfUpload.addEventListener('click', () => modalPdfInput.click());
        modalPdfUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            modalPdfUpload.classList.add('dragover');
        });
        modalPdfUpload.addEventListener('dragleave', () => {
            modalPdfUpload.classList.remove('dragover');
        });
        modalPdfUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            modalPdfUpload.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handlePdfUpload(Array.from(files));
        });
        
        modalPdfInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handlePdfUpload(files);
        });
        
        // Manage PDFs button
        managePdfBtn.addEventListener('click', () => {
            openPdfModal();
        });
        
        // Close PDF modal when clicking outside
        pdfModal.addEventListener('click', (e) => {
            if (e.target.id === 'pdfModal') {
                closePdfModal();
            }
        });
        
        // Folder control event listeners
        pdfFolderInput.addEventListener('input', updateCurrentFolder);
        createFolderBtn.addEventListener('click', createFolder);
        
        // Date control event listeners
        postDateInput.addEventListener('change', updatePublicationStatus);
        postTimeInput.addEventListener('change', updatePublicationStatus);
        
        // Initialize date and folder
        initializeDateAndFolder();
        
        function handlePdfUpload(files) {
            files.forEach(file => {
                if (file.type === 'application/pdf') {
                    const pdfInfo = {
                        name: file.name,
                        size: formatFileSize(file.size),
                        file: file,
                        id: Date.now() + Math.random()
                    };
                    
                    uploadedPdfs.push(pdfInfo);
                    renderPdfList();
                    renderPdfManagementList();
                }
            });
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function renderPdfList() {
            pdfList.innerHTML = '';
            if (uploadedPdfs.length === 0) {
                pdfList.innerHTML = '<p style="text-align: center; color: #999; font-style: italic; padding: 20px;">No PDFs uploaded yet</p>';
                return;
            }
            
            uploadedPdfs.forEach(pdf => {
                const pdfItem = document.createElement('div');
                pdfItem.className = 'pdf-item';
                pdfItem.innerHTML = `
                    <div class="pdf-item-info">
                        <i class="fas fa-file-pdf pdf-item-icon"></i>
                        <div class="pdf-item-details">
                            <div class="pdf-item-name">${pdf.name}</div>
                            <div class="pdf-item-size">${pdf.size} â€¢ Will save to: docs/${currentPdfFolder}/</div>
                        </div>
                    </div>
                    <div class="pdf-item-actions">
                        <button class="pdf-action-btn insert" onclick="insertPdfLink('${pdf.id}')">
                            <i class="fas fa-plus"></i> Insert
                        </button>
                        <button class="pdf-action-btn delete" onclick="removePdf('${pdf.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                pdfList.appendChild(pdfItem);
            });
        }
        
        function renderPdfManagementList() {
            pdfManagementList.innerHTML = '';
            if (uploadedPdfs.length === 0) {
                pdfManagementList.innerHTML = '<p style="text-align: center; color: #999; font-style: italic; padding: 20px;">No PDFs uploaded yet</p>';
                return;
            }
            
            uploadedPdfs.forEach(pdf => {
                const pdfItem = document.createElement('div');
                pdfItem.className = 'pdf-management-item';
                pdfItem.innerHTML = `
                    <div class="pdf-management-info">
                        <i class="fas fa-file-pdf" style="color: #ff6b6b; font-size: 20px;"></i>
                        <div class="pdf-management-details">
                            <h4>${pdf.name}</h4>
                            <p>${pdf.size} â€¢ Will save to: docs/${currentPdfFolder}/</p>
                        </div>
                    </div>
                    <div class="pdf-item-actions">
                        <button class="pdf-action-btn insert" onclick="insertPdfLink('${pdf.id}')">
                            <i class="fas fa-plus"></i> Insert
                        </button>
                        <button class="pdf-action-btn delete" onclick="removePdf('${pdf.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                pdfManagementList.appendChild(pdfItem);
            });
        }
        
        function insertPdfLink(pdfId) {
            const pdf = uploadedPdfs.find(p => p.id === pdfId);
            if (!pdf) return;
            
            // Prompt for display name and description
            const displayName = prompt('Enter display name for the PDF link:', pdf.name.replace('.pdf', ''));
            if (!displayName) return;
            
            const description = prompt('Enter description for the PDF:', '');
            
            const textarea = document.getElementById('postContent');
            const cursorPos = textarea.selectionStart;
            
            // Create the PDF link in the same format as whale-watching.html
            // Note: We use the current folder name, not a hardcoded category
            const pdfLink = `<p><a href="../docs/${currentPdfFolder}/${pdf.name}" target="_blank">'${displayName}'</a> ${description}.</p>`;
            
            // Insert at cursor position with proper line breaks
            const beforeCursor = textarea.value.substring(0, cursorPos);
            const afterCursor = textarea.value.substring(cursorPos);
            
            // Add line break before if not at start and previous char is not a line break
            const needsLineBefore = cursorPos > 0 && !beforeCursor.endsWith('\n');
            const needsLineAfter = afterCursor.length > 0 && !afterCursor.startsWith('\n');
            
            let insertText = pdfLink;
            if (needsLineBefore) insertText = '\n' + insertText;
            if (needsLineAfter) insertText = insertText + '\n';
            
            textarea.value = beforeCursor + insertText + afterCursor;
            
            // Set cursor position after the inserted link
            const newCursorPos = cursorPos + insertText.length;
            textarea.focus();
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            
            // Update preview if active
            if (previewPanel.classList.contains('active')) {
                updatePreview();
            }
            
            // Update content stats
            updateContentStats();
            
            closePdfModal();
        }
        

        
        function updateCurrentFolder() {
            const folderName = pdfFolderInput.value.trim().toLowerCase().replace(/[^a-z0-9-_]/g, '-');
            currentPdfFolder = folderName || 'misc';
            currentFolderSpan.textContent = currentPdfFolder;
        }
        
        function createFolder() {
            const folderName = pdfFolderInput.value.trim();
            if (!folderName) {
                alert('Please enter a folder name');
                return;
            }
            
            // Sanitize folder name
            const sanitizedFolder = folderName.toLowerCase().replace(/[^a-z0-9-_]/g, '-');
            currentPdfFolder = sanitizedFolder;
            pdfFolderInput.value = sanitizedFolder;
            currentFolderSpan.textContent = sanitizedFolder;
            
            // Show success message
            const successMessage = document.getElementById('successMessage');
            successMessage.innerHTML = `<i class="fas fa-check-circle"></i> Folder "${sanitizedFolder}" created successfully!`;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }
        
        function initializeDateAndFolder() {
            // Set default date to today in local timezone
            const today = new Date();
            const localDate = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            postDateInput.value = localDate;
            postTimeInput.value = '09:00';
            updatePublicationStatus();
            
            // Initialize folder
            updateCurrentFolder();
        }
        
        function setDate(preset) {
            const today = new Date();
            let targetDate = new Date();
            
            switch(preset) {
                case 'today':
                    targetDate = today;
                    break;
                case 'tomorrow':
                    targetDate.setDate(today.getDate() + 1);
                    break;
                case 'next-week':
                    targetDate.setDate(today.getDate() + 7);
                    break;
                case 'next-month':
                    targetDate.setMonth(today.getMonth() + 1);
                    break;
            }
            
            // Convert to local timezone
            const localDate = new Date(targetDate.getTime() - (targetDate.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            postDateInput.value = localDate;
            updatePublicationStatus();
        }
        
        function setTime(preset) {
            switch(preset) {
                case 'morning':
                    postTimeInput.value = '09:00';
                    break;
                case 'noon':
                    postTimeInput.value = '12:00';
                    break;
                case 'evening':
                    postTimeInput.value = '18:00';
                    break;
                case 'night':
                    postTimeInput.value = '21:00';
                    break;
            }
            updatePublicationStatus();
        }
        
        function updatePublicationStatus() {
            const selectedDate = new Date(postDateInput.value);
            const selectedTime = postTimeInput.value;
            
            if (!selectedDate || !selectedTime) {
                statusIndicator.className = 'status-indicator past';
                statusText.textContent = 'Please select date and time';
                return;
            }
            
            // Create full datetime
            const [hours, minutes] = selectedTime.split(':');
            selectedDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            const now = new Date();
            
            if (selectedDate < now) {
                statusIndicator.className = 'status-indicator past';
                statusText.textContent = 'Date/time is in the past';
            } else if (selectedDate.getTime() - now.getTime() < 60000) { // Within 1 minute
                statusIndicator.className = 'status-indicator';
                statusText.textContent = 'Ready to publish now';
            } else {
                statusIndicator.className = 'status-indicator scheduled';
                const timeDiff = selectedDate.getTime() - now.getTime();
                const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hoursDiff = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                if (daysDiff > 0) {
                    statusText.textContent = `Scheduled for ${daysDiff} day${daysDiff !== 1 ? 's' : ''} and ${hoursDiff} hour${hoursDiff !== 1 ? 's' : ''} from now`;
                } else if (hoursDiff > 0) {
                    statusText.textContent = `Scheduled for ${hoursDiff} hour${hoursDiff !== 1 ? 's' : ''} from now`;
                } else {
                    const minutesDiff = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                    statusText.textContent = `Scheduled for ${minutesDiff} minute${minutesDiff !== 1 ? 's' : ''} from now`;
                }
            }
        }
        
        function removePdf(pdfId) {
            uploadedPdfs = uploadedPdfs.filter(p => p.id !== pdfId);
            renderPdfList();
            renderPdfManagementList();
        }
        
        function openPdfModal() {
            pdfModal.style.display = 'block';
        }
        
        function closePdfModal() {
            pdfModal.style.display = 'none';
        }
        
        // Store original form submission handler
        const originalFormSubmit = document.getElementById('postForm').onsubmit;
        
        // Override form submission to handle scheduling and PDF uploads
        document.getElementById('postForm').onsubmit = null;
        document.getElementById('postForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            
            try {
                // Upload PDFs first if any
                if (uploadedPdfs.length > 0) {
                    try {
                        await uploadPdfs();
                    } catch (error) {
                        console.error('PDF upload failed:', error);
                        errorMessage.textContent = `âŒ PDF upload failed: ${error.message}`;
                        errorMessage.style.display = 'block';
                        return;
                    }
                }
                
                // Get form data
                const title = document.getElementById('postTitle').value;
                const content = document.getElementById('postContent').value;
                const category = document.getElementById('postCategory').value;
                const date = document.getElementById('postDate').value;
                const time = document.getElementById('postTime').value;
                const metaDescription = document.getElementById('metaDescription').value;
                const urlSlug = document.getElementById('urlSlug').value;
                const sendNewsletter = document.getElementById('sendNewsletter').checked;
                
                // Create scheduled datetime
                const scheduledFor = date && time ? new Date(`${date}T${time}`) : new Date();
                const now = new Date();
                
                const options = {
                    category: category,
                    tags: tags,
                    metaDescription: metaDescription,
                    urlSlug: urlSlug,
                    seoKeywords: seoKeywords,
                    sendNewsletter: sendNewsletter
                };
                
                // Check if this should be published immediately or scheduled
                if (scheduledFor <= now || scheduledFor.getTime() - now.getTime() < 60000) { // Within 1 minute
                    // Publish immediately
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
                    
                    // Generate individual post page
                    await generatePostPage(title, content, options);
                    
                    // Add post to website
                    const post = postManager.quickAdd(title, content, options);
                    
                    // Send newsletter if checkbox is checked
                    if (sendNewsletter) {
                        try {
                            const newsletterResult = await supabaseNewsletter.sendNewsletter(post);
                            successMessage.innerHTML = `
                                <i class="fas fa-check-circle"></i> Post published successfully! 
                                Newsletter sent to ${newsletterResult.sent} subscribers.
                            `;
                        } catch (newsletterError) {
                            successMessage.innerHTML = `
                                <i class="fas fa-check-circle"></i> Post published successfully! 
                                Newsletter sending failed: ${newsletterError.message}
                            `;
                        }
                    } else {
                        successMessage.innerHTML = `
                            <i class="fas fa-check-circle"></i> Post published successfully!
                        `;
                    }
                } else {
                    // Schedule for later
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scheduling...';
                    
                    // Schedule the post
                    const response = await fetch('/.netlify/functions/schedule-post', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            title: title,
                            content: content,
                            options: options,
                            scheduledFor: scheduledFor.toISOString()
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const scheduledTime = new Date(scheduledFor);
                        const timeString = scheduledTime.toLocaleString();
                        
                        successMessage.innerHTML = `
                            <i class="fas fa-clock"></i> Post scheduled successfully! 
                            Will be published on ${timeString}
                        `;
                    } else {
                        throw new Error(result.error || 'Failed to schedule post');
                    }
                }
                
                // Show success
                successMessage.style.display = 'block';
                await clearDraft(); // Clear the draft when post is published/scheduled
                clearForm();
                
            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = `âŒ Error: ${error.message}`;
                errorMessage.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Publish Post';
            }
        });
        
        async function uploadPdfs() {
            for (const pdf of uploadedPdfs) {
                const formData = new FormData();
                formData.append('file', pdf.file);
                formData.append('category', currentPdfFolder);
                formData.append('filename', pdf.name);
                
                try {
                    const response = await fetch('/.netlify/functions/upload-pdf', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to upload ${pdf.name}`);
                    }
                    
                    console.log(`Successfully uploaded ${pdf.name}`);
                } catch (error) {
                    console.error(`Error uploading ${pdf.name}:`, error);
                    throw error;
                }
            }
        }

        // Scheduled Posts Functions
        async function loadScheduledPosts() {
            const scheduledPostsList = document.getElementById('scheduledPostsList');
            scheduledPostsList.innerHTML = '<p>Loading scheduled posts...</p>';
            
            try {
                const response = await fetch('/.netlify/functions/get-scheduled-posts');
                const result = await response.json();
                
                if (result.scheduledPosts && result.scheduledPosts.length > 0) {
                    renderScheduledPosts(result.scheduledPosts);
                } else {
                    scheduledPostsList.innerHTML = '<p class="no-scheduled-posts">No scheduled posts found</p>';
                }
            } catch (error) {
                console.error('Error loading scheduled posts:', error);
                scheduledPostsList.innerHTML = '<p class="error">Error loading scheduled posts</p>';
            }
        }

        function renderScheduledPosts(posts) {
            const scheduledPostsList = document.getElementById('scheduledPostsList');
            
            const postsHtml = posts.map(post => {
                const scheduledTime = new Date(post.scheduledFor);
                const timeString = scheduledTime.toLocaleString();
                const timeUntil = getTimeUntil(scheduledTime);
                
                return `
                    <div class="scheduled-post-item">
                        <div class="scheduled-post-info">
                            <div class="scheduled-post-title">${post.title}</div>
                            <div class="scheduled-post-time">
                                Scheduled for: ${timeString} (${timeUntil})
                            </div>
                        </div>
                        <div class="scheduled-post-actions">
                            <button type="button" class="button small danger" onclick="deleteScheduledPost('${post.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            scheduledPostsList.innerHTML = postsHtml;
        }

        function getTimeUntil(scheduledTime) {
            const now = new Date();
            const diff = scheduledTime.getTime() - now.getTime();
            
            if (diff <= 0) {
                return 'Due now';
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return `${days} day${days !== 1 ? 's' : ''} and ${hours} hour${hours !== 1 ? 's' : ''}`;
            } else if (hours > 0) {
                return `${hours} hour${hours !== 1 ? 's' : ''} and ${minutes} minute${minutes !== 1 ? 's' : ''}`;
            } else {
                return `${minutes} minute${minutes !== 1 ? 's' : ''}`;
            }
        }

        async function deleteScheduledPost(postId) {
            if (!confirm('Are you sure you want to delete this scheduled post?')) {
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/delete-scheduled-post', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ postId: postId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Reload the scheduled posts list
                    loadScheduledPosts();
                } else {
                    alert('Error deleting scheduled post: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting scheduled post:', error);
                alert('Error deleting scheduled post');
            }
        }
    </script>
</body>
</html> 